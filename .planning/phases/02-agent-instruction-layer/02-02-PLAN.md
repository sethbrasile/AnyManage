---
phase: 02-agent-instruction-layer
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - STATE.md
  - docs/protocols/session-protocol.md
  - docs/protocols/command-patterns.md
  - docs/protocols/error-recovery.md
  - docs/protocols/agent-optimization.md
autonomous: true

must_haves:
  truths:
    - "STATE.md exists as minimal session state template"
    - "Session protocol is fully documented in docs/protocols/"
    - "Command parsing rules are documented"
    - "Error recovery patterns are documented"
    - "Agent optimization tradeoffs are documented"
  artifacts:
    - path: "STATE.md"
      provides: "Session state template"
      min_lines: 15
      contains: "Current Work"
    - path: "docs/protocols/session-protocol.md"
      provides: "Full session initialization documentation"
      min_lines: 50
    - path: "docs/protocols/command-patterns.md"
      provides: "Command parsing documentation"
      min_lines: 40
    - path: "docs/protocols/error-recovery.md"
      provides: "Checkpoint and recovery patterns"
      min_lines: 60
    - path: "docs/protocols/agent-optimization.md"
      provides: "Agent-specific optimization guidance"
      min_lines: 40
  key_links:
    - from: "INSTRUCTIONS.md"
      to: "docs/protocols/session-protocol.md"
      via: "Reference pointer"
      pattern: "session-protocol"
    - from: "docs/protocols/session-protocol.md"
      to: "STATE.md"
      via: "Startup sequence"
      pattern: "STATE\\.md"
---

<objective>
Create STATE.md template and docs/protocols/ documentation files that INSTRUCTIONS.md references.

Purpose: INSTRUCTIONS.md contains pointers to detailed documentation. This plan creates that documentation so agents can find complete operational details when needed.

Output:
- `/STATE.md` - Minimal session state template
- `/docs/protocols/session-protocol.md` - Full session initialization details
- `/docs/protocols/command-patterns.md` - Command parsing and execution
- `/docs/protocols/error-recovery.md` - Checkpoint and recovery patterns
- `/docs/protocols/agent-optimization.md` - Agent-specific optimizations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-instruction-layer/02-CONTEXT.md
@.planning/phases/02-agent-instruction-layer/02-RESEARCH.md
@INSTRUCTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create STATE.md minimal session state template</name>
  <files>STATE.md</files>
  <action>
Create STATE.md at project root as a minimal session state template.

**Format (from RESEARCH.md):**

```markdown
# Current Work State

**Last Updated:** [timestamp]

## Active Work
[Brief description of current task or "No active work"]

## Progress
- [ ] [Current task items if any]

## Last Action
[What was last completed]

## Next Steps
- [What to do next]

## Context Files
- [Relevant files for current work]
```

**Requirements from CONTEXT.md:**
- Minimal (<50 lines when populated)
- Human-readable and agent-parseable
- Loaded on every session startup
- Updated at end of work sessions

**Initial state:** Template with placeholders showing structure. When agent starts fresh session with no prior work, this is what STATE.md looks like.

Create as template - actual values filled in during operation.
  </action>
  <verify>
1. File exists at `/STATE.md`
2. File contains "Current Work State" or "Active Work" header
3. File contains "Last Updated" placeholder
4. File is <30 lines (template form)
5. `wc -l STATE.md` returns <= 30
  </verify>
  <done>
STATE.md exists as minimal session state template with:
- Active Work section
- Progress checkboxes
- Last Action
- Next Steps
- Context Files list
  </done>
</task>

<task type="auto">
  <name>Task 2: Create docs/protocols/ documentation files</name>
  <files>
docs/protocols/session-protocol.md
docs/protocols/command-patterns.md
docs/protocols/error-recovery.md
docs/protocols/agent-optimization.md
  </files>
  <action>
Create docs/protocols/ directory and four documentation files that INSTRUCTIONS.md references.

**1. session-protocol.md (~60-80 lines)**

Full session initialization details:
- Startup sequence (step by step)
- STATE.md loading rules
- PAUSE.md detection and resume flow
- Silent start rationale
- What to load vs what to defer
- Token budget guidance (<2000 tokens on startup)
- Examples of STATE.md states (fresh, mid-work, paused)
- grepai watch lifecycle (start on file ops, stop on session close) - from CONTEXT.md

**2. command-patterns.md (~50-70 lines)**

Command parsing documentation:
- Natural language parsing approach
- Slash command format (`/command-name args`)
- Entity extraction (client names from natural language)
- Batch operation detection
- Confirmation rules (destructive vs read vs add)
- Examples of equivalent commands
- Namespace conventions for future skills

**3. error-recovery.md (~70-90 lines)**

Checkpoint and recovery patterns:
- When to create checkpoints (multi-step operations)
- Checkpoint format (JSON in .checkpoints/)
- FAILED.md format (plain English)
- Recovery options (resume, skip, restart)
- Missing file handling (offer to create)
- Stale context reconciliation
- Example checkpoint JSON
- Example recovery dialogue

**4. agent-optimization.md (~50-70 lines)**

Agent-specific optimization guidance (from CONTEXT.md decision):
- Document "Agent-Optimized vs Identical Behavior" tradeoff
- Tier 1 (Claude Code): Full capabilities, can preload more
- Tier 2 (opencode/codex): Core file ops, minimal preload
- Tier 3 (read-only): Generate instructions for user
- Graceful degradation examples
- When to offer manual fallbacks
- Testing matrix for cross-agent validation
- Note: This is documentation of the approach, not agent detection code

**Plain English throughout** - these docs may be read by non-technical users in troubleshooting scenarios.
  </action>
  <verify>
1. `ls docs/protocols/` shows all 4 files
2. Each file has >= 40 lines
3. session-protocol.md contains "STATE.md"
4. command-patterns.md contains "slash command" or "/command"
5. error-recovery.md contains "checkpoint"
6. agent-optimization.md contains "graceful degradation" or "Tier"
  </verify>
  <done>
docs/protocols/ exists with four documentation files:
- session-protocol.md - Full session initialization details
- command-patterns.md - Command parsing and execution rules
- error-recovery.md - Checkpoint and recovery patterns
- agent-optimization.md - Agent capability tiers and fallbacks

All files use plain English, provide examples, and complete the documentation INSTRUCTIONS.md points to.
  </done>
</task>

</tasks>

<verification>
- [ ] STATE.md exists at project root with minimal template format
- [ ] docs/protocols/ directory exists with 4 files
- [ ] session-protocol.md documents full startup sequence
- [ ] command-patterns.md documents natural language + slash commands
- [ ] error-recovery.md documents checkpoint and recovery
- [ ] agent-optimization.md documents agent capability tiers
- [ ] All protocol docs use plain English (no jargon)
- [ ] All protocol docs include examples
</verification>

<success_criteria>
1. Agent can find detailed session startup instructions in docs/protocols/session-protocol.md
2. Agent can find command parsing rules in docs/protocols/command-patterns.md
3. Agent can find error recovery patterns in docs/protocols/error-recovery.md
4. Agent can understand capability tiers from docs/protocols/agent-optimization.md
5. STATE.md provides clear template for session state tracking
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-instruction-layer/02-02-SUMMARY.md`
</output>
