---
phase: 03-entity-management
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - docs/protocols/git-abstraction.md
  - docs/protocols/action-logging.md
  - ops/logs/.gitkeep
  - .gitignore
  - INSTRUCTIONS.md
autonomous: true

must_haves:
  truths:
    - "User never sees git commands, terminology, or error messages"
    - "Changes are saved automatically at workflow breakpoints"
    - "All agent actions are logged for traceability"
    - "Git errors surface as simple 'couldn't save' messages"
    - "Log files are gitignored and won't clutter the repository"
  artifacts:
    - path: "docs/protocols/git-abstraction.md"
      provides: "Complete git automation protocol"
      contains: "## Zero Git Exposure"
    - path: "docs/protocols/action-logging.md"
      provides: "Complete action logging protocol"
      contains: "## Log Format"
    - path: "ops/logs/.gitkeep"
      provides: "Logs directory exists"
    - path: ".gitignore"
      provides: "Logs directory is gitignored"
      contains: "ops/logs/"
  key_links:
    - from: "INSTRUCTIONS.md"
      to: "docs/protocols/git-abstraction.md"
      via: "reference in Code Style section"
      pattern: "git-abstraction"
---

<objective>
Create git abstraction and action logging protocol documentation that ensures users never see git complexity while maintaining full traceability of agent actions.

Purpose: These are the "invisible infrastructure" workflows - they support all other operations but should be completely transparent to users. Git abstraction is critical for the non-technical user target. Logging is critical for debugging and audit trails.

Output: Two protocol documents, logging directory structure, gitignore updates, and INSTRUCTIONS.md references.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-entity-management/03-CONTEXT.md

# Reference prior plan output
@.planning/phases/03-entity-management/03-01-SUMMARY.md

# Existing files
@INSTRUCTIONS.md
@docs/protocols/session-protocol.md
@docs/protocols/error-recovery.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git abstraction protocol documentation</name>
  <files>docs/protocols/git-abstraction.md</files>
  <action>
Create comprehensive protocol documentation for invisible git management. The document must cover:

**Core Principle: Zero Git Exposure**
Users should NEVER see:
- Git commands (git add, git commit, git push)
- Git terminology (commit, branch, merge, conflict)
- Git errors (merge conflict, detached HEAD, etc.)
- Git prompts (commit messages, author info)

**When to Save (Batch Commits):**
Trigger automatic saves at natural workflow breakpoints:
- After entity onboarding completes
- After note processing finishes
- After profile updates complete
- After any workflow that modified files
- On session end/pause (if uncommitted changes exist)
- After 5 minutes idle with uncommitted changes

**Commit Message Format:**
Human-readable messages that appear in git history (for admin/developer reference only):
- "Created Acme Corp entity with profile and roadmap"
- "Updated Acme Corp profile: added new CEO"
- "Processed notes for Acme Corp: 3 tasks, 1 profile update"
- "Session checkpoint: multiple entity updates"

Pattern: `[Action] [Entity]: [brief description]`

**Error Handling:**
Git operations can fail. Handle gracefully:

1. **Transient errors** (network issues, file locks):
   - Retry automatically (3 attempts, exponential backoff)
   - Log each attempt
   - Only surface error if all retries fail

2. **Persistent errors** (corruption, conflicts):
   - Log full error details to ops/logs/git-errors.log
   - Surface simple message: "Couldn't save changes. Your work is preserved locally."
   - DO NOT show git error messages to user
   - Offer: "Try again?" or "Continue without saving?"

3. **Merge conflicts:**
   - These should be rare in single-user scenario
   - Log conflict details
   - Surface: "There was a conflict saving changes. An administrator may need to help."
   - DO NOT attempt automatic resolution (data loss risk)

**What Gets Committed:**
- All entity files (entities/*)
- Templates (templates/*)
- Master ROADMAP.md
- STATE.md, PAUSE.md
- Configuration files (CONFIG.md)

**What Does NOT Get Committed:**
- ops/logs/ (gitignored)
- Any file matching .gitignore patterns
- Temporary files

**Silent Operation:**
- No "Saving..." messages during commits
- No "Saved!" confirmations after commits
- Git operations happen in background, user continues working
- Only surface issues if they prevent work from continuing

Format: Follow existing protocol doc style. Include error handling flowchart.
  </action>
  <verify>
File exists at docs/protocols/git-abstraction.md with:
- Zero git exposure principles
- Commit trigger points
- Commit message format
- Error handling with retry logic
- What gets committed / what doesn't
- Silent operation guidelines
  </verify>
  <done>
Protocol covers all CONTEXT.md decisions: zero git exposure, batched commits, descriptive messages, silent retry, error logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create action logging protocol documentation</name>
  <files>docs/protocols/action-logging.md</files>
  <action>
Create comprehensive protocol documentation for agent action logging. The document must cover:

**Purpose:**
Logging provides:
- Traceability for debugging (what did the agent do?)
- Audit trail for compliance (who changed what, when?)
- Support for ENTY-06 requirement (subagent/specialist logging)

**Log Location:**
```
ops/
  logs/
    agent-actions.log    <- All agent actions
    git-errors.log       <- Git operation failures
```

These directories/files are gitignored - they stay local for debugging, not shared in repo.

**Log Format:**
Use structured log entries (one JSON object per line for parseability):

```
{"timestamp":"2026-01-24T15:30:00Z","action":"entity_created","entity":"Acme Corp","details":{"type":"client","files":["ENTITY_PROFILE.md","ENTITY_ROADMAP.md"]}}
{"timestamp":"2026-01-24T15:31:00Z","action":"profile_updated","entity":"Acme Corp","details":{"section":"Key Contacts","change":"added row"}}
{"timestamp":"2026-01-24T15:32:00Z","action":"notes_processed","entity":"Acme Corp","details":{"tasks_added":3,"profile_updates":1,"source":"inline"}}
```

**Action Types:**
| Action | When Logged | Details Captured |
|--------|-------------|------------------|
| entity_created | After onboarding | entity name, type, files created |
| entity_deleted | After deletion | entity name, files removed |
| profile_updated | After profile change | entity, section, change type |
| roadmap_updated | After roadmap change | entity, tasks added/modified |
| notes_processed | After note processing | entity, extraction counts, source |
| git_commit | After successful commit | message, files count |
| git_error | After git failure | error type, message, retry count |
| session_start | On session init | loaded context files |
| session_end | On pause/end | uncommitted changes count |

**Log Rotation:**
- Keep logs for 14 days
- Maximum file size: 10MB
- When rotating: rename current to agent-actions.log.1, start new file
- Agent can check size and rotate, or admin can set up cron

**Viewing Logs:**
For admin/developer debugging:
- Logs are plain text JSON lines, readable with any text editor
- Can grep for specific actions: `grep "entity_created" agent-actions.log`
- Can filter by entity: `grep "Acme Corp" agent-actions.log`

Users should NOT be directed to read logs - this is developer/admin tooling.

**Subagent Logging (ENTY-06):**
When subagents/specialists are implemented (Phase 5), they log with additional context:
```
{"timestamp":"...","action":"specialist_invoked","specialist":"assessment-specialist","entity":"Acme Corp","task":"quarterly review"}
{"timestamp":"...","action":"specialist_completed","specialist":"assessment-specialist","entity":"Acme Corp","deliverable":"AUDIT_FINDINGS.md"}
```

Document this now so the pattern is established.

Format: Follow existing protocol doc style.
  </action>
  <verify>
File exists at docs/protocols/action-logging.md with:
- Log location specification (ops/logs/)
- JSON line format with examples
- Action types table
- Log rotation guidelines
- Subagent logging pattern for Phase 5
  </verify>
  <done>
Protocol satisfies ENTY-06 (subagent/specialist logging) and provides traceability foundation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create logging directory and update gitignore</name>
  <files>ops/logs/.gitkeep, .gitignore</files>
  <action>
**Create ops/logs/ directory structure:**

Create file: ops/logs/.gitkeep with content:
```
# Log files directory
# This folder contains agent action logs for debugging and traceability.
# Files here are gitignored - they stay local, not shared in the repository.
#
# Expected files:
# - agent-actions.log: All agent workflow actions
# - git-errors.log: Git operation failures
#
# See docs/protocols/action-logging.md for log format documentation.
```

**Update .gitignore:**

Check if .gitignore exists at project root. If it does, read it first.

Add these entries (if not already present):
```
# Agent logs (local debugging only)
ops/logs/*.log
ops/logs/*.log.*
```

If .gitignore doesn't exist, create it with:
```
# Agent PM .gitignore

# Agent logs (local debugging only)
ops/logs/*.log
ops/logs/*.log.*

# OS files
.DS_Store
Thumbs.db

# Editor files
*.swp
*~
```
  </action>
  <verify>
- ops/logs/.gitkeep exists with documentation comment
- .gitignore exists and contains ops/logs/*.log pattern
- Running `git check-ignore ops/logs/test.log` returns the path (meaning it would be ignored)
  </verify>
  <done>
Logging directory exists and is properly gitignored.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update INSTRUCTIONS.md with git and logging references</name>
  <files>INSTRUCTIONS.md</files>
  <action>
Update INSTRUCTIONS.md to reference both protocols.

**In "Code Style" section, update git bullet:**

Current text (approximately):
```
- **Git operations invisible** to user (automated and silent)
```

Replace with:
```
- **Git operations invisible** to user - automated, silent, no git terminology exposed. See `docs/protocols/git-abstraction.md` for implementation.
```

**Add new bullet in "Code Style" section:**
```
- **Action logging** - all agent actions logged to ops/logs/ for traceability. See `docs/protocols/action-logging.md`.
```

**In "File Structure" section, ensure ops/ includes logs:**

Current ops/ entry shows:
```
  ops/                <- Team operations and playbooks
```

Update to:
```
  ops/                <- Team operations, playbooks, and logs (logs gitignored)
```

**Do NOT modify other sections.** Keep changes minimal.
  </action>
  <verify>
INSTRUCTIONS.md contains:
- Git abstraction protocol reference in Code Style
- Action logging protocol reference in Code Style
- Updated ops/ description in File Structure
  </verify>
  <done>
INSTRUCTIONS.md points to both infrastructure protocols.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Verify docs/protocols/git-abstraction.md exists and is >80 lines
2. Verify docs/protocols/action-logging.md exists and is >80 lines
3. Verify ops/logs/.gitkeep exists
4. Verify .gitignore contains ops/logs/ patterns
5. Verify INSTRUCTIONS.md references both protocols
6. Test: `git check-ignore ops/logs/test.log` should return the path
</verification>

<success_criteria>
- Git abstraction protocol fully documented (zero exposure, batched commits, error handling)
- Action logging protocol fully documented (format, rotation, subagent pattern)
- Logging directory exists and is gitignored
- INSTRUCTIONS.md updated with protocol references
- Ready for Phase 5 specialist logging (pattern documented)
</success_criteria>

<output>
After completion, create `.planning/phases/03-entity-management/03-03-SUMMARY.md`
</output>
