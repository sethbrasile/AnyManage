---
phase: 08-integration-patterns
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/INTEGRATION_TEMPLATE.md
  - .github/skills/add-integration/SKILL.md
  - docs/protocols/integration-framework.md
autonomous: true

must_haves:
  truths:
    - "Developers can create new integrations following a consistent template"
    - "Users can say 'Add integration' and get guided setup"
    - "Integration skills follow a consistent hook pattern (setup, sync, error)"
    - "Agent searches trusted sources and handles installation without user editing configs"
  artifacts:
    - path: "templates/INTEGRATION_TEMPLATE.md"
      provides: "Reusable template for creating integration skills"
      min_lines: 80
      contains: "Required Hooks"
    - path: ".github/skills/add-integration/SKILL.md"
      provides: "Guided setup skill for adding integrations"
      min_lines: 60
    - path: "docs/protocols/integration-framework.md"
      provides: "Protocol documentation for integration behavior"
      min_lines: 100
  key_links:
    - from: ".github/skills/add-integration/SKILL.md"
      to: "docs/protocols/integration-framework.md"
      via: "Protocol reference"
      pattern: "integration-framework"
    - from: "templates/INTEGRATION_TEMPLATE.md"
      to: "docs/protocols/integration-framework.md"
      via: "Framework reference"
      pattern: "integration-framework"
---

<objective>
Create integration skill framework with template and guided setup skill.

Purpose: Integration skills need a consistent pattern so new integrations (Trello, Calendar, CRM) follow the same structure. The add-integration skill provides agent-driven setup where users never touch config files.

Output:
- templates/INTEGRATION_TEMPLATE.md - template for creating new integration skills
- .github/skills/add-integration/SKILL.md - guided setup skill
- docs/protocols/integration-framework.md - protocol documentation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integration-patterns/08-CONTEXT.md
@.planning/phases/08-integration-patterns/08-RESEARCH.md
@INSTRUCTIONS.md
@.github/skills/process-notes/SKILL.md
@.github/skills/get-status/SKILL.md
@docs/SKILL_AUTHORING_GUIDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create templates/INTEGRATION_TEMPLATE.md</name>
  <files>templates/INTEGRATION_TEMPLATE.md</files>
  <action>
Create integration skill template that developers can copy to create new integration skills.

Structure:

1. **Frontmatter template**
```yaml
---
name: [integration-name]-sync
description: Sync tasks with [Service Name]
triggers:
  - "sync [service]"
  - "sync with [service]"
  - "update [service]"
  - "[service] sync"
integration:
  service: "[service-name]"
  mcp_server: "[npm-package-name]"
  requires_auth: true
---
```

2. **Required Hooks Section**
   - `setup`: How to configure the integration (credential collection, MCP server install)
   - `sync`: How to perform sync operations (pull, push, bidirectional)
   - `error_handling`: How to handle failures (graceful degradation pattern)

3. **Optional Hooks Section**
   - `status`: How to check integration health
   - `disconnect`: How to remove integration
   - `conflict_resolution`: Custom conflict handling

4. **Hook Documentation Template**
For each hook:
```markdown
### [Hook Name]

**Trigger:** [when this hook runs]

**Behavior:**
1. [Step 1]
2. [Step 2]

**Error Handling:**
- [error case]: [response]

**User Communication:**
- Success: "[message]"
- Failure: "[message]"
```

5. **Credential Requirements Template**
```markdown
## Credentials

| Credential | Source | User Obtains From |
|------------|--------|-------------------|
| API_KEY | Manual | [URL to dashboard] |
| TOKEN | Generated | [URL to generate] |
```

6. **Rate Limits Section Template**
```markdown
## Rate Limits

| Limit | Value | Handling |
|-------|-------|----------|
| Per minute | [N] | [strategy] |
```

7. **Dual Source of Truth Mapping Template**
```markdown
## Data Mapping

| External Field | Local Field | Sync Direction |
|----------------|-------------|----------------|
| status | task checkbox | bidirectional |
| due_date | metadata | external -> local |
```

Reference docs/protocols/integration-framework.md for behavior details.
  </action>
  <verify>File exists with 80+ lines, contains "Required Hooks" section, has frontmatter template</verify>
  <done>Developers have a complete template for creating new integration skills</done>
</task>

<task type="auto">
  <name>Task 2: Create .github/skills/add-integration/SKILL.md</name>
  <files>.github/skills/add-integration/SKILL.md</files>
  <action>
Create guided setup skill that walks users through adding any integration.

Structure:

1. **Frontmatter**
```yaml
---
name: add-integration
description: Set up a new external tool integration
triggers:
  - "add integration"
  - "add [service] integration"
  - "connect [service]"
  - "set up [service]"
  - "integrate with [service]"
---
```

2. **Behavior Section**

**Phase 1: Discovery**
- If no service specified: List available integrations (Trello, more coming)
- If service specified: Confirm and proceed

**Phase 2: Prerequisite Check**
- Check if Node.js/npm available (required for MCP servers)
- If missing: "You'll need Node.js installed. Want me to help with that?"
- Offer to install via homebrew (macOS) or suggest download link

**Phase 3: Server Search**
- Search trusted sources for MCP server:
  - Official MCP Registry (registry.modelcontextprotocol.io)
  - npm verified publishers
  - Known good packages list in docs
- Present found option with brief description

**Phase 4: Credential Collection**
- Guide user to credential source step by step
- For Trello example:
  1. "First, go to trello.com/power-ups/admin"
  2. "Create a new Power-Up (any name works)"
  3. "Copy your API Key"
  4. User provides key
  5. Generate token URL with their key
  6. User authorizes and provides token

**Phase 5: Installation**
- Install MCP server using appropriate method:
  - Claude Code: `claude mcp add --transport stdio ...`
  - opencode: Update opencode.json mcp section
- Never show raw commands to user - just "Setting up connection..."

**Phase 6: Verification**
- Test connection automatically
- Report success: "Connected! Try 'sync trello' to see your tasks."
- Report failure: Explain what went wrong, offer retry

**Error Handling:**
- Missing prerequisites: Offer installation help
- Auth failure: Guide through credential regeneration
- Network issues: "Couldn't connect. Check your internet and try again."

Reference docs/protocols/integration-framework.md for protocol details.
  </action>
  <verify>File exists with 60+ lines, contains credential collection phase, has prerequisite check</verify>
  <done>Users can say "Add Trello integration" and get guided setup without touching config files</done>
</task>

<task type="auto">
  <name>Task 3: Create docs/protocols/integration-framework.md</name>
  <files>docs/protocols/integration-framework.md</files>
  <action>
Create protocol documentation for integration behavior following existing protocol format (see entity-onboarding.md pattern).

Structure:

1. **Protocol Overview**
   - Purpose: Consistent integration behavior across all external tools
   - Core principle: Agent handles technical complexity, user provides only credentials

2. **Integration Lifecycle**
   - Discovery -> Setup -> Active -> Sync -> (Error -> Recovery) -> Disconnect
   - State diagram in text form

3. **Required Hooks**

**Setup Hook (REQUIRED)**
- Trigger: "Add [service] integration"
- Responsibilities:
  - Prerequisite verification (Node.js, etc.)
  - MCP server discovery from trusted sources
  - Credential collection with step-by-step guidance
  - MCP configuration (claude mcp add or JSON update)
  - Connection verification
- User sees: Guided prompts, success/failure message
- User never sees: JSON, config files, npm commands

**Sync Hook (REQUIRED)**
- Trigger: "Sync [service]", automatic on session start
- Responsibilities:
  - Pull external changes
  - Push local changes
  - Handle conflicts (external wins on true conflict)
  - Update INTEGRATIONS.md status
- User sees: Brief sync summary ("Synced 3 tasks from Trello")
- User never sees: API calls, raw data

**Error Hook (REQUIRED)**
- Trigger: Any integration failure
- Responsibilities:
  - Log to ops/logs/agent-actions.log (sanitized - no credentials)
  - Display inline notice: "[Service] unavailable, using local data"
  - One silent retry (5-second delay)
  - On reconnect: Prompt for sync
- Circuit breaker states: CLOSED -> OPEN -> HALF-OPEN -> CLOSED

4. **Optional Hooks**

**Status Hook**
- Trigger: "Check integrations", session startup
- Returns: Integration health, last sync time

**Disconnect Hook**
- Trigger: "Remove [service] integration"
- Removes MCP configuration, updates INTEGRATIONS.md

**Conflict Resolution Hook**
- Custom handling beyond "external wins"
- Default: External wins, notify user

5. **Graceful Degradation Protocol**
   - Step 1: Detect failure
   - Step 2: Log error (sanitized)
   - Step 3: Notify user inline
   - Step 4: Silent retry (one attempt)
   - Step 5: If still failing, enter local-only mode
   - Step 6: Monitor for recovery
   - Step 7: On recovery, prompt sync

6. **Session Startup Integration Check**
   - Read INTEGRATIONS.md for configured integrations
   - For each: Quick health check (timeout: 3s)
   - Display status summary:
     ```
     Integrations: Trello (connected) | Calendar (not configured)
     ```

7. **Credential Security**
   - Never log full credentials
   - Use `***` masking in logs
   - Store in environment variables (handled by MCP config)
   - User provides once, agent stores securely

8. **Rate Limit Handling**
   - Detect rate limit responses (429)
   - Notify user: "Rate limited. Will retry in [X] minutes."
   - Queue operations for retry
   - Never silently drop operations

9. **Rollback on Failure**
   - Before multi-step sync: Create checkpoint
   - On failure mid-operation: Rollback to checkpoint
   - Notify user: "Sync failed. No changes were made."
  </action>
  <verify>File exists with 100+ lines, contains Required Hooks section, has Graceful Degradation Protocol</verify>
  <done>Integration behavior is fully documented for consistent implementation</done>
</task>

</tasks>

<verification>
- [ ] templates/INTEGRATION_TEMPLATE.md exists with hook documentation
- [ ] .github/skills/add-integration/SKILL.md exists with guided setup flow
- [ ] docs/protocols/integration-framework.md exists with protocol details
- [ ] Template references framework protocol
- [ ] Skill references framework protocol
- [ ] No user-facing content asks user to edit config files
</verification>

<success_criteria>
1. A developer can copy INTEGRATION_TEMPLATE.md and create a new integration skill
2. Users can say "Add integration" and get guided setup
3. Integration skills follow consistent hook pattern (setup, sync, error)
4. Protocol documentation covers all behavior including graceful degradation
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-patterns/08-02-SUMMARY.md`
</output>
